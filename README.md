# Nap Alarm App（仮眠アラーム）

## 目的（Why）

- 短時間（15〜60分、または最大24時間までの任意時間）の仮眠を快適にとるためのWebアラームを提供する  
- 好きな音楽（外部URL）で起きたい  
- アプリ不要・Webで完結するシンプルな使いやすさを目指す  
- 将来的には Google AdSense での収益化も検討  

---

## 想定ユーザー（Who）

- 昼休みに仮眠をとる社会人  
- 勉強中にリフレッシュしたい学生  
- アプリを入れずにブラウザで済ませたい人  
- 開発者本人  

---

## 使用シーン（When/Where）

- デスクや職場で15〜60分程度の仮眠を取りたいとき  
- 寝る前にスマホで仮眠タイマーをセットしたいとき  
- リモートワーク中の短い休憩を効率的に取りたいとき  

---

## 機能要件（What）

| No | 機能名 | 内容 |
|----|--------|------|
| 1 | 仮眠時間選択 | 15・30・45・60分＋カスタム（最大24時間まで） |
| 2 | タイマー機能 | JavaScriptでカウントダウン、時間になったら音楽再生 |
| 3 | 音楽再生 | 任意の音楽URLを入力し、時間になったら自動再生（MP3/YouTube等） |
| 4 | ユーザー登録 | 名前＋パスワードのみで登録、メールアドレス不要 |
| 5 | 自動ログアウト | 最終ログインから2ヶ月でセッション削除 |
| 6 | 履歴表示 | 過去の仮眠設定（時間＋音楽URL）を最大5件表示 |
| 7 | 広告表示 | 仮眠中の画面下にバナー広告＋画面サイドにレスポンシブ広告 |

---

## 技術選定（How）

| 項目 | 技術 | 理由 |
|------|------|------|
| バックエンド | Ruby on Rails | 認証・DB処理に強い　|
| フロント | HTML + SCSS + JavaScript | 軽量で柔軟、見た目と動作を制御 |
| タイマー | `setTimeout` + `<audio>` or `<iframe>` | 自動再生とアラーム機能を簡潔に実装 |
| 音楽URL登録 | 入力フォーム + DB保存 | 好きな音楽を指定可能にするため |
| データ保存 | PostgreSQL | 本番運用・デプロイに最適 |
| 認証 | 独自（name + password） | 最小限の認証で手軽に使える |
| セッション管理 | `remember_token` または `expires_at` 列 | 自動ログアウト制御 |
| 履歴保存 | `NapHistory`モデル | 過去5件のタイマーと音楽履歴を表示 |
| 広告 | Google AdSense（レスポンシブ広告） | ページ下部とサイドに収益導線を設置 |

---

## 🚀 今後の展望（拡張予定）

- スヌーズ機能（再度数分後に起こす）
- PWA対応（スマホホーム追加、オフライン動作）
- 音量フェードイン
- 多言語対応

---

## 使い方（追加仕様）

### キーボード操作
> 入力欄（input/textarea/select, contenteditable）にフォーカスがある場合は反応しません。

| キー | カウント中 | 0秒で鳴動中 | 備考 |
|---|---|---|---|
| Space | 一時停止 / 再開 | 停止（音・通知・タイトル点滅を停止、UI復帰） | 画面スクロールは抑止 |
| Esc | 音停止（再生中なら停止） | 停止（Space と同じ） | |
| S | いまから +5 分に再設定して再開 | +5 分でスヌーズ（停止→延長→即再開） | 残り時間に加算ではなく「現在時刻から +5 分」です |

### 画面とUIの振る舞い
- **new（設定画面）**  
  - 音量スライダーの値は `localStorage("nap_volume")` に保存されます。
  - 「音をテスト」は入力URLを直再生。未入力時はビープ音で確認できます。
  - 送信時、直近10件（時間＋音源URL）を `localStorage("nap_alarm_history")` に保存します（重複除外、最大10）。
- **show（カウントダウン）**  
  - 初期値（`ends_at_ms` もしくは `duration_ms`）が有効なら自動でカウント開始します。
  - 再生音量は **保存された音量** を `<audio>` とビープの両方に適用します。
  - 0秒到達で鳴動すると、ボタン表示が **「スヌーズ(+5分)」「停止」** に切り替わります。停止・スヌーズ・リセットで **「開始/再開」「一時停止」** に戻ります。
  - 実行中はタブ離脱時に確認ダイアログ（`beforeunload`）を表示し、**一時停止/停止/リセット/完了** で解除します。

### 通知・振動・スリープ抑止
- 通知：権限が **granted** かつ **背景タブ** のときにデスクトップ通知を表示します（ブラウザ依存）。
- バイブレーション：`navigator.vibrate` 対応端末で動作。
- 画面スリープ抑止：対応ブラウザで `navigator.wakeLock("screen")` を取得。タブを再表示した際は自動で取り直します。
- 既知の制限：モバイルOSやブラウザの省電力・自動再生規制の影響を受けます（特に iOS Safari）。バックグラウンドではタイマー精度や再生が低下・抑止されることがあります。

### ローカルストレージ
- `nap_volume` … `0.0–1.0` の数値。テスト・本番再生の双方に適用。
- `nap_alarm_history` … 直近10件の `{ duration_ms, music_url, at }`。新規送信時に更新。

### URL パラメータ（`/alarm` の show）
- `ends_at_ms`（必須）: アラームの絶対時刻（ミリ秒）  
- `duration_ms`（任意）: 残り時間（ミリ秒）。`ends_at_ms` があればどちらでも可。  
- `music_url`（任意）: 再生する音源URL（直リンク推奨）。未指定時はビープ音。

### 開発メモ
- 起動：`bin/dev`（Rails + Tailwind 同時実行）  
- Tailwind 再ビルド：`bin/rails tailwindcss:build`  
- Stimulus コントローラ：
  - new: `alarm_form_controller.js`（テスト再生・音量・履歴）
  - show: `alarm_controller.js`（カウント・再生・キーボード・スヌーズ）

### テスト手順（簡易）
1. new 画面で音量を下げ「音をテスト」→音量が反映されること。  
2. 「アラーム開始へ」→ show に遷移し自動でカウント開始。  
3. 0秒で鳴動後、Space または Esc → 停止しボタンが通常表示に戻る。  
4. 鳴動中に **S** → 停止→ +5分で即再開。  
5. カウント中に **S** → 現在時刻から +5分で再スタート（残り時間に加算しない）。


## 既知の不具合／ブラウザ別メモ

### 全般（まずこれだけ覚えておけばOK）
- **バックグラウンド・画面OFFでは精度が落ちる／鳴らないことがある。**  
  ブラウザはバックグラウンドでタイマーと音再生を強く節約する。画面が点灯＆タブが前面だと安定。
- **自動再生規制**：音の再生は原則「ユーザー操作」から始める必要がある。`開始` 直後に解錠しているが、環境によっては **手動で再生ボタンを押す** 必要あり。
- **音源URL**：クロスオリジン（別ドメイン）だと **CORS** が必要。`mp3` が最も無難。再生に失敗したらビープにフォールバック。
- **通知**は権限許可が前提。**タブが非表示の時のみ**出る仕様のブラウザがある。  
- **バイブ**は対応端末のみ（非対応端末は黙る）。
- **Wake Lock**（画面スリープ抑止）は対応ブラウザでのみ有効。非対応環境では普通にスリープする。
- **beforeunload（離脱ガード）**は一部モバイルで無視される。PC/Androidは比較的安定。
- **ローカルストレージ**はプライベートブラウジングや企業端末で保存できない場合あり（音量・履歴が消える）。

---

### ブラウザ別の傾向（要約）

#### iOS Safari（iPhone/iPad）
- 期待できること  
  - ユーザー操作に続く再生は通ることが多い。Web Audio のビープは安定。
- 制限・注意  
  - バックグラウンドや画面OFFだとタイマー・音再生が遅延／停止しやすい。  
  - 通知は制限が多い。PWAとしてインストールしないと出ないケースがある。  
  - `beforeunload` 無視されがち。**離脱ガードは過信しない。**

#### Android Chrome
- 期待できること  
  - 画面ON＆前面なら安定。`vibrate` も動きやすい。  
  - Wake Lock が効く機種が多い（画面を点けっぱなしにできる）。
- 制限・注意  
  - 省電力モードやブラウザ設定でバックグラウンド時に鈍る。  
  - メーカー独自の電池最適化でキルされることがある。

#### Chrome / Edge（デスクトップ）
- 期待できること  
  - 前面タブでの精度・再生は安定。通知・離脱ガードも概ねOK。
- 制限・注意  
  - バックグラウンドタブはタイマーが粗くなる。  
  - 社内端末などで通知がポリシー制限されることあり。

#### Safari（macOS）
- 期待できること  
  - 前面なら安定。ビープは安定。
- 制限・注意  
  - 自動再生の判定が厳しめ。音源URLの直リンクでも弾かれることがある。  
  - Wake Lock の挙動が不安定なバージョンあり。

#### Firefox（デスクトップ/Android）
- 期待できること  
  - 前面での再生・カウントは素直。
- 制限・注意  
  - バックグラウンド時のタイマー間引きが強い。  
  - 自動再生の扱いが版ごとに変わる。音量ゼロやミュート扱いになることあり。

---

### よくある症状と対処
- **「0秒になっても鳴らない／遅れる」**  
  → タブが背景・画面OFF・省電力のいずれか。画面ONで前面に出し、Wake Lock が効く環境なら有効化。  
- **「音源URLが鳴らない」**  
  → CORS ヘッダ不足 or 非対応コーデック。`mp3` を推奨。`音をテスト`で再現確認。  
- **「通知が出ない」**  
  → 権限未許可／ブラウザ仕様（モバイルSafariなど）。そもそも **タブが見えている間は出ない** ブラウザもある。  
- **「バイブしない」**  
  → 端末非対応。これは仕様。  
- **「履歴／音量が保存されない」**  
  → プライベートモードやストレージ制限。通常モードで確認。

---

### 推奨運用（現実解）
- モバイルで厳密な時刻で鳴らしたい場合は、**画面ON・前面タブ**で利用。  
- 音源は **mp3直リンク** を使い、事前に `音をテスト`。  
- 重要な場面は **ネイティブアプリやPWA** の併用を検討。

---

### バグ報告テンプレ


