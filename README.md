# Nap Alarm App（仮眠アラーム）

## 目的（Why）

- 短時間（15〜60分、または最大24時間までの任意時間）の仮眠を快適にとるためのWebアラームを提供する  
- 好きな音楽（外部URL）で起きたい  
- アプリ不要・Webで完結するシンプルな使いやすさを目指す  
- 将来的には Google AdSense での収益化も検討  

---

## 想定ユーザー（Who）

- 昼休みに仮眠をとる社会人  
- 勉強中にリフレッシュしたい学生  
- アプリを入れずにブラウザで済ませたい人  
- 開発者本人  

---

## 使用シーン（When/Where）

- デスクや職場で15〜60分程度の仮眠を取りたいとき  
- 寝る前にスマホで仮眠タイマーをセットしたいとき  
- リモートワーク中の短い休憩を効率的に取りたいとき  

---

## 機能要件（What）

| No | 機能名 | 内容 |
|----|--------|------|
| 1 | 仮眠時間選択 | 15・30・45・60分＋カスタム（最大24時間まで） |
| 2 | タイマー機能 | JavaScriptでカウントダウン、時間になったら音楽再生 |
| 3 | 音楽再生 | 任意の音楽URLを入力し、時間になったら自動再生（MP3/YouTube等） |
| 4 | ユーザー登録 | 名前＋パスワードのみで登録、メールアドレス不要 |
| 5 | 自動ログアウト | 最終ログインから2ヶ月でセッション削除 |
| 6 | 履歴表示 | 過去の仮眠設定（時間＋音楽URL）を最大5件表示 |
| 7 | 広告表示 | 仮眠中の画面下にバナー広告＋画面サイドにレスポンシブ広告 |

---

## 技術選定（How）

| 項目 | 技術 | 理由 |
|------|------|------|
| バックエンド | Ruby on Rails | 認証・DB処理に強い　|
| フロント | HTML + SCSS + JavaScript | 軽量で柔軟、見た目と動作を制御 |
| タイマー | `setTimeout` + `<audio>` or `<iframe>` | 自動再生とアラーム機能を簡潔に実装 |
| 音楽URL登録 | 入力フォーム + DB保存 | 好きな音楽を指定可能にするため |
| データ保存 | PostgreSQL | 本番運用・デプロイに最適 |
| 認証 | 独自（name + password） | 最小限の認証で手軽に使える |
| セッション管理 | `remember_token` または `expires_at` 列 | 自動ログアウト制御 |
| 履歴保存 | `NapHistory`モデル | 過去5件のタイマーと音楽履歴を表示 |
| 広告 | Google AdSense（レスポンシブ広告） | ページ下部とサイドに収益導線を設置 |

---

## 🚀 今後の展望（拡張予定）

- スヌーズ機能（再度数分後に起こす）
- PWA対応（スマホホーム追加、オフライン動作）
- 音量フェードイン
- 多言語対応

---

## 使い方（追加仕様）

### キーボード操作
> 入力欄（input/textarea/select, contenteditable）にフォーカスがある場合は反応しません。

| キー | カウント中 | 0秒で鳴動中 | 備考 |
|---|---|---|---|
| Space | 一時停止 / 再開 | 停止（音・通知・タイトル点滅を停止、UI復帰） | 画面スクロールは抑止 |
| Esc | 音停止（再生中なら停止） | 停止（Space と同じ） | |
| S | いまから +5 分に再設定して再開 | +5 分でスヌーズ（停止→延長→即再開） | 残り時間に加算ではなく「現在時刻から +5 分」です |

### 画面とUIの振る舞い
- **new（設定画面）**  
  - 音量スライダーの値は `localStorage("nap_volume")` に保存されます。
  - 「音をテスト」は入力URLを直再生。未入力時はビープ音で確認できます。
  - 送信時、直近10件（時間＋音源URL）を `localStorage("nap_alarm_history")` に保存します（重複除外、最大10）。
- **show（カウントダウン）**  
  - 初期値（`ends_at_ms` もしくは `duration_ms`）が有効なら自動でカウント開始します。
  - 再生音量は **保存された音量** を `<audio>` とビープの両方に適用します。
  - 0秒到達で鳴動すると、ボタン表示が **「スヌーズ(+5分)」「停止」** に切り替わります。停止・スヌーズ・リセットで **「開始/再開」「一時停止」** に戻ります。
  - 実行中はタブ離脱時に確認ダイアログ（`beforeunload`）を表示し、**一時停止/停止/リセット/完了** で解除します。

### 通知・振動・スリープ抑止
- 通知：権限が **granted** かつ **背景タブ** のときにデスクトップ通知を表示します（ブラウザ依存）。
- バイブレーション：`navigator.vibrate` 対応端末で動作。
- 画面スリープ抑止：対応ブラウザで `navigator.wakeLock("screen")` を取得。タブを再表示した際は自動で取り直します。
- 既知の制限：モバイルOSやブラウザの省電力・自動再生規制の影響を受けます（特に iOS Safari）。バックグラウンドではタイマー精度や再生が低下・抑止されることがあります。

### ローカルストレージ
- `nap_volume` … `0.0–1.0` の数値。テスト・本番再生の双方に適用。
- `nap_alarm_history` … 直近10件の `{ duration_ms, music_url, at }`。新規送信時に更新。

### URL パラメータ（`/alarm` の show）
- `ends_at_ms`（必須）: アラームの絶対時刻（ミリ秒）  
- `duration_ms`（任意）: 残り時間（ミリ秒）。`ends_at_ms` があればどちらでも可。  
- `music_url`（任意）: 再生する音源URL（直リンク推奨）。未指定時はビープ音。

### 開発メモ
- 起動：`bin/dev`（Rails + Tailwind 同時実行）  
- Tailwind 再ビルド：`bin/rails tailwindcss:build`  
- Stimulus コントローラ：
  - new: `alarm_form_controller.js`（テスト再生・音量・履歴）
  - show: `alarm_controller.js`（カウント・再生・キーボード・スヌーズ）

### テスト手順（簡易）
1. new 画面で音量を下げ「音をテスト」→音量が反映されること。  
2. 「アラーム開始へ」→ show に遷移し自動でカウント開始。  
3. 0秒で鳴動後、Space または Esc → 停止しボタンが通常表示に戻る。  
4. 鳴動中に **S** → 停止→ +5分で即再開。  
5. カウント中に **S** → 現在時刻から +5分で再スタート（残り時間に加算しない）。

