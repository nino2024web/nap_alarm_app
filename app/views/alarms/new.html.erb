<div class="mx-auto max-w-xl p-6">
  <h1 class="text-2xl font-semibold">Nap Alarm</h1>
  <% if flash[:alert] %>
    <p class="mt-3 text-red-600"><%= flash[:alert] %></p>
  <% end %>
  <%= form_with url: alarm_path, method: :post, local: true, class: "mt-6 space-y-6", data: { controller: "alarm-form" }  do |f| %>
    <!-- 時間（プリセット＋カスタム） -->
    <fieldset class="space-y-2" data-action="change->alarm-form#presetChanged">
      <legend class="font-medium">時間（どれにする？）</legend>
      <div class="flex flex-wrap gap-4">
        <label class="inline-flex items-center gap-2"><%= radio_button_tag :preset, "15", true %><span>15分</span></label>
        <label class="inline-flex items-center gap-2"><%= radio_button_tag :preset, "20" %><span>20分</span></label>
        <label class="inline-flex items-center gap-2"><%= radio_button_tag :preset, "30" %><span>30分</span></label>
        <label class="inline-flex items-center gap-2"><%= radio_button_tag :preset, "45" %><span>45分</span></label>
        <label class="inline-flex items-center gap-2"><%= radio_button_tag :preset, "60" %><span>60分</span></label>
        <label class="inline-flex items-center gap-2">
          <%= radio_button_tag :preset, "custom" %><span>カスタム</span>
          <div class="ml-2 inline-flex items-center gap-2">
            <%= number_field_tag :custom_hours, 0, min: 0, max: 24, step: 1,
                  class: "w-16 border rounded px-2 py-1 no-spin",
                  data: { "alarm-form-target": "hours" } %><span>時間</span>
            <%= number_field_tag :custom_minutes, 0, min: 0, max: 59, step: 1,
                  class: "w-16 border rounded px-2 py-1 no-spin",
                  data: { "alarm-form-target": "minutes" } %><span>分</span>
            <%= number_field_tag :custom_seconds, 0, min: 0, max: 59, step: 1,
                  class: "w-16 border rounded px-2 py-1 no-spin",
                  data: { "alarm-form-target": "seconds" } %><span>秒</span>
          </div>
        </label>
      </div>
    </fieldset>
    <!-- アラーム音の選択 -->
    <fieldset class="space-y-2">
      <legend class="font-medium">アラーム音</legend>
      <p class="text-sm text-gray-600">直リンク推奨。開始ボタンは必ず押してね（自動再生規制）。</p>
      <div class="grid gap-3">
        <select class="w-full border rounded px-3 py-2"
                data-alarm-form-target="source"
                data-action="change->alarm-form#sourceChanged">
          <option value="asset:<%= asset_path('alarm/bell.wav') %>">Bell（デフォルト）</option>
          <option value="asset:<%= asset_path('alarm/chime.wav') %>">Chime</option>
          <option value="asset:<%= asset_path('alarm/digital.wav') %>">Digital</option>
          <option value="asset:<%= asset_path('alarm/marimba.wav') %>">Marimba風</option>
          <option value="asset:<%= asset_path('alarm/radar.wav') %>">Radar風</option>
          <option value="youtube">YouTubeリンク（題名表示＋同タブプレビュー）</option>
        </select>
        <!-- 外部URL入力（YouTube） -->
        <div class="flex items-center gap-3" data-alarm-form-target="urlRow" hidden>
          <%= url_field_tag :music_url, nil,
            placeholder: "https://www.youtube.com/watch?v=...",
            class: "w-full border rounded px-3 py-2",
            data: { "alarm-form-target": "musicUrl", action: "input->alarm-form#urlChanged" } %>
        </div>
        <!-- テスト／停止は常時表示（asset でも押せる） -->
        <div class="flex items-center gap-3">
          <button type="button"
                  class="inline-flex items-center justify-center rounded border px-3 py-2
                         transition-colors hover:bg-blue-50 hover:border-blue-400 hover:text-blue-700
                         focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400"
                  data-action="alarm-form#testSound">
            音をテスト
          </button>
          <button type="button"
                  class="inline-flex items-center justify-center rounded border px-3 py-2
                         transition-colors hover:bg-rose-50 hover:border-rose-400 hover:text-rose-700
                         focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-400"
                  data-action="alarm-form#stopTest">
            停止
          </button>
          <span class="text-xs text-gray-500" data-alarm-form-target="testHint"></span>
        </div>
        <!-- YouTube題名＋同タブプレビュー -->
        <div class="rounded border p-3 space-y-2" data-alarm-form-target="ytMeta" hidden>
          <div class="text-xs text-gray-600">YouTube題名</div>
          <div class="text-sm" data-alarm-form-target="ytTitle">（URL未入力）</div>
          <button type="button"
                  class="inline-flex items-center justify-center rounded border px-3 py-2
                         transition-colors hover:bg-blue-50 hover:border-blue-400 hover:text-blue-700
                         focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400"
                  data-action="alarm-form#testSound">
            このタブでプレビュー再生
          </button>
        </div>
        <!-- 同タブYouTubeテストの iframe 埋め込み先（非表示でOK） -->
        <div data-alarm-form-target="ytTest"
        style="position:absolute;width:1px;height:1px;overflow:hidden;pointer-events:none;"
        aria-hidden="true">
        </div>
        <!-- 音量 -->
        <div class="flex items-center gap-3">
          <label class="text-sm text-gray-600">音量</label>
          <input type="range" min="0" max="1" step="0.01" value="1"
                 class="w-full"
                 data-alarm-form-target="volume"
                 data-action="input->alarm-form#volumeChanged">
          <span class="text-sm text-gray-600" data-alarm-form-target="volLabel">100%</span>
        </div>
        <!-- 履歴 -->
        <div class="mt-1">
          <h2 class="font-medium">直近10件</h2>
          <ul class="space-y-2" data-alarm-form-target="historyList"></ul>
          <button type="button"
                  class="mt-2 inline-flex items-center justify-center rounded border px-3 py-2
                         transition-colors hover:bg-slate-50 hover:border-slate-400 hover:text-slate-700
                         focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400"
                  data-action="alarm-form#clearHistory">
            履歴クリア
          </button>
        </div>
      </div>
    </fieldset>
    <!-- 送信（hover色あり） -->
    <%= f.submit "アラーム開始へ",
          class: "inline-flex items-center justify-center rounded border px-4 py-2
                  transition-colors hover:bg-blue-50 hover:border-blue-400 hover:text-blue-700
                  focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400" %>
    <!-- 鳴動時間の固定（“30秒”フォールバック用） -->
    <%= hidden_field_tag :ring_seconds, 30 %>
  <% end %>
</div>
